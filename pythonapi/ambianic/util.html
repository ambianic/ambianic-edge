<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>ambianic.util API documentation</title>
<meta name="description" content="Service classes for OS interaction and multithreading." />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>ambianic.util</code></h1>
</header>
<section id="section-intro">
<p>Service classes for OS interaction and multithreading.</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;Service classes for OS interaction and multithreading.&#34;&#34;&#34;
import asyncio
import json
import logging
import time
import traceback
from abc import abstractmethod
from threading import Event, Thread

import numpy as np

log = logging.getLogger(__name__)


class ManagedService:
    &#34;&#34;&#34;A service contract with lifecycle methods.&#34;&#34;&#34;

    @abstractmethod
    def start(self, **kwargs):
        &#34;&#34;&#34;Start and run until finished or asked to stop().&#34;&#34;&#34;

    @abstractmethod
    def stop(self):
        &#34;&#34;&#34;Exit start() method as soon as possible.

        Delay to exit may result in forceful process termination.
        &#34;&#34;&#34;

    @abstractmethod
    def healthcheck(self):
        &#34;&#34;&#34;Report vital health information.

        :Returns:
        -------
        touple (time, string)
            (latest_heartbeat_timestamp, status_code)
            latest_heartbeat_timestamp is in the format of time.monotonic().
            status_code should have a semantic mapping to the service health.

        &#34;&#34;&#34;
        return time.monotonic(), &#34;OK&#34;

    def heal(self):
        &#34;&#34;&#34;Inspect and repair the state of the job.

        This method is normally invoked from a management service when
        a long running job doesn&#39;t seem healthy.
        Most likely because healthstate() returns bad reports:
        such as outdated heartbeat timestamp or a bad status code.
        The method should try to bring the job back to a healthy state
        as soon as possible to prevent forceful termination.
        &#34;&#34;&#34;


class ThreadedJob(Thread, ManagedService):
    &#34;&#34;&#34;A job that runs in its own python thread.

    Jobs managed by Threaded Job must implement all ManagedService methods.
    &#34;&#34;&#34;

    # Reminder: even though multiple processes can work well for pipelines,
    # since they are mostly independent,
    # Google Coral does not allow access to it from different processes yet.
    # Consider moving access to coral in a separate process that can serve
    # an inference task queue from multiple pipelines.

    def __init__(self, job=None, **kwargs):
        &#34;&#34;&#34;Inititalize with a ManagedService.

        :Parameters:
        ----------
        job : ManagedService
            The underlying service wrapped in this thread.
        &#34;&#34;&#34;
        Thread.__init__(self, daemon=True)
        assert isinstance(job, ManagedService)
        self.job = job
        # The shutdown_flag is a threading.Event object that
        # indicates whether the thread should be terminated.
        # self.shutdown_flag = threading.Event()
        # ... Other thread setup code here ...
        self._stop_requested = Event()

    def run(self):
        log.info(
            &#34;Thread #%s started with job: %s&#34;, self.ident, self.job.__class__.__name__
        )
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        self.job.start()
        log.info(
            &#34;Thread #%s for job %s stopped&#34;, self.ident, self.job.__class__.__name__
        )

    def stop(self):
        log.debug(
            &#34;Thread #%s for job %s is signalled to stop&#34; &#34;Passing request to job.&#34;,
            self.ident,
            self.job.__class__.__name__,
        )
        self._stop_requested.set()
        self.job.stop()

    def heal(self):
        log.debug(
            &#34;Thread #%s for job %s is signalled to heal.&#34; &#34;Passing request to job.&#34;,
            self.ident,
            self.job.__class__.__name__,
        )
        self.job.heal()
        log.debug(
            &#34;Thread #%s for job %s completed heal request.&#34;,
            self.ident,
            self.job.__class__.__name__,
        )

    def healthcheck(self):
        log.debug(
            &#34;Thread #%s for job %s healthcheck requested.&#34; &#34;Passing request to job.&#34;,
            self.ident,
            self.job.__class__.__name__,
        )
        health_status = self.job.healthcheck()
        return health_status


class ServiceExit(Exception):
    &#34;&#34;&#34;Main program exit signal.

    Custom exception which is used to trigger clean exit
    of all running threads and the main program.

    Method for controlled multi-threaded Python app exit
    suggested by George Notaras:
    https://www.g-loaded.eu/2016/11/24/how-to-terminate-running-python-threads-using-signals/
    &#34;&#34;&#34;


def stacktrace():
    &#34;&#34;&#34;Get stack trace as a multi line string.

    :Returns:
    -------
    string
        Milti-line string of current stack trace.

    &#34;&#34;&#34;
    formatted_lines = traceback.format_exc().splitlines()
    strace = &#34;Runtime stack trace:\n %s&#34; + &#34;\n&#34;.join(formatted_lines)
    return strace


class JsonEncoder(json.JSONEncoder):
    def default(self, obj):
        if isinstance(obj, np.integer):
            return int(obj)
        if isinstance(obj, np.floating):
            return float(obj)
        if isinstance(obj, np.ndarray):
            return obj.tolist()

        return super().default(obj)


def jsonify(val: any = None):
    return json.dumps(val, cls=JsonEncoder)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="ambianic.util.jsonify"><code class="name flex">
<span>def <span class="ident">jsonify</span></span>(<span>val: <built-in function any> = None)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def jsonify(val: any = None):
    return json.dumps(val, cls=JsonEncoder)</code></pre>
</details>
</dd>
<dt id="ambianic.util.stacktrace"><code class="name flex">
<span>def <span class="ident">stacktrace</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Get stack trace as a multi line string.</p>
<h2 id="returns">:Returns:</h2>
<p>string
Milti-line string of current stack trace.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def stacktrace():
    &#34;&#34;&#34;Get stack trace as a multi line string.

    :Returns:
    -------
    string
        Milti-line string of current stack trace.

    &#34;&#34;&#34;
    formatted_lines = traceback.format_exc().splitlines()
    strace = &#34;Runtime stack trace:\n %s&#34; + &#34;\n&#34;.join(formatted_lines)
    return strace</code></pre>
</details>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="ambianic.util.JsonEncoder"><code class="flex name class">
<span>class <span class="ident">JsonEncoder</span></span>
<span>(</span><span>*, skipkeys=False, ensure_ascii=True, check_circular=True, allow_nan=True, sort_keys=False, indent=None, separators=None, default=None)</span>
</code></dt>
<dd>
<div class="desc"><p>Extensible JSON <a href="http://json.org">http://json.org</a> encoder for Python data structures.</p>
<p>Supports the following objects and types by default:</p>
<p>+-------------------+---------------+
| Python
| JSON
|
+===================+===============+
| dict
| object
|
+-------------------+---------------+
| list, tuple
| array
|
+-------------------+---------------+
| str
| string
|
+-------------------+---------------+
| int, float
| number
|
+-------------------+---------------+
| True
| true
|
+-------------------+---------------+
| False
| false
|
+-------------------+---------------+
| None
| null
|
+-------------------+---------------+</p>
<p>To extend this to recognize other objects, subclass and implement a
<code>.default()</code> method with another method that returns a serializable
object for <code>o</code> if possible, otherwise it should call the superclass
implementation (to raise <code>TypeError</code>).</p>
<p>Constructor for JSONEncoder, with sensible defaults.</p>
<p>If skipkeys is false, then it is a TypeError to attempt
encoding of keys that are not str, int, float or None.
If
skipkeys is True, such items are simply skipped.</p>
<p>If ensure_ascii is true, the output is guaranteed to be str
objects with all incoming non-ASCII characters escaped.
If
ensure_ascii is false, the output can contain non-ASCII characters.</p>
<p>If check_circular is true, then lists, dicts, and custom encoded
objects will be checked for circular references during encoding to
prevent an infinite recursion (which would cause an OverflowError).
Otherwise, no such check takes place.</p>
<p>If allow_nan is true, then NaN, Infinity, and -Infinity will be
encoded as such.
This behavior is not JSON specification compliant,
but is consistent with most JavaScript based encoders and decoders.
Otherwise, it will be a ValueError to encode such floats.</p>
<p>If sort_keys is true, then the output of dictionaries will be
sorted by key; this is useful for regression tests to ensure
that JSON serializations can be compared on a day-to-day basis.</p>
<p>If indent is a non-negative integer, then JSON array
elements and object members will be pretty-printed with that
indent level.
An indent level of 0 will only insert newlines.
None is the most compact representation.</p>
<p>If specified, separators should be an (item_separator, key_separator)
tuple.
The default is (', ', ': ') if <em>indent</em> is <code>None</code> and
(',', ': ') otherwise.
To get the most compact JSON representation,
you should specify (',', ':') to eliminate whitespace.</p>
<p>If specified, default is a function that gets called for objects
that can't otherwise be serialized.
It should return a JSON encodable
version of the object or raise a <code>TypeError</code>.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class JsonEncoder(json.JSONEncoder):
    def default(self, obj):
        if isinstance(obj, np.integer):
            return int(obj)
        if isinstance(obj, np.floating):
            return float(obj)
        if isinstance(obj, np.ndarray):
            return obj.tolist()

        return super().default(obj)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li>json.encoder.JSONEncoder</li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="ambianic.util.JsonEncoder.default"><code class="name flex">
<span>def <span class="ident">default</span></span>(<span>self, obj)</span>
</code></dt>
<dd>
<div class="desc"><p>Implement this method in a subclass such that it returns
a serializable object for <code>o</code>, or calls the base implementation
(to raise a <code>TypeError</code>).</p>
<p>For example, to support arbitrary iterators, you could
implement default like this::</p>
<pre><code>def default(self, o):
    try:
        iterable = iter(o)
    except TypeError:
        pass
    else:
        return list(iterable)
    # Let the base class default method raise the TypeError
    return JSONEncoder.default(self, o)
</code></pre></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def default(self, obj):
    if isinstance(obj, np.integer):
        return int(obj)
    if isinstance(obj, np.floating):
        return float(obj)
    if isinstance(obj, np.ndarray):
        return obj.tolist()

    return super().default(obj)</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="ambianic.util.ManagedService"><code class="flex name class">
<span>class <span class="ident">ManagedService</span></span>
</code></dt>
<dd>
<div class="desc"><p>A service contract with lifecycle methods.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class ManagedService:
    &#34;&#34;&#34;A service contract with lifecycle methods.&#34;&#34;&#34;

    @abstractmethod
    def start(self, **kwargs):
        &#34;&#34;&#34;Start and run until finished or asked to stop().&#34;&#34;&#34;

    @abstractmethod
    def stop(self):
        &#34;&#34;&#34;Exit start() method as soon as possible.

        Delay to exit may result in forceful process termination.
        &#34;&#34;&#34;

    @abstractmethod
    def healthcheck(self):
        &#34;&#34;&#34;Report vital health information.

        :Returns:
        -------
        touple (time, string)
            (latest_heartbeat_timestamp, status_code)
            latest_heartbeat_timestamp is in the format of time.monotonic().
            status_code should have a semantic mapping to the service health.

        &#34;&#34;&#34;
        return time.monotonic(), &#34;OK&#34;

    def heal(self):
        &#34;&#34;&#34;Inspect and repair the state of the job.

        This method is normally invoked from a management service when
        a long running job doesn&#39;t seem healthy.
        Most likely because healthstate() returns bad reports:
        such as outdated heartbeat timestamp or a bad status code.
        The method should try to bring the job back to a healthy state
        as soon as possible to prevent forceful termination.
        &#34;&#34;&#34;</code></pre>
</details>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="ambianic.pipeline.PipeElement" href="pipeline/index.html#ambianic.pipeline.PipeElement">PipeElement</a></li>
<li><a title="ambianic.pipeline.interpreter.Pipeline" href="pipeline/interpreter.html#ambianic.pipeline.interpreter.Pipeline">Pipeline</a></li>
<li><a title="ambianic.pipeline.interpreter.PipelineServer" href="pipeline/interpreter.html#ambianic.pipeline.interpreter.PipelineServer">PipelineServer</a></li>
<li><a title="ambianic.pipeline.interpreter.PipelineServerJob" href="pipeline/interpreter.html#ambianic.pipeline.interpreter.PipelineServerJob">PipelineServerJob</a></li>
<li><a title="ambianic.util.ThreadedJob" href="#ambianic.util.ThreadedJob">ThreadedJob</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="ambianic.util.ManagedService.heal"><code class="name flex">
<span>def <span class="ident">heal</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Inspect and repair the state of the job.</p>
<p>This method is normally invoked from a management service when
a long running job doesn't seem healthy.
Most likely because healthstate() returns bad reports:
such as outdated heartbeat timestamp or a bad status code.
The method should try to bring the job back to a healthy state
as soon as possible to prevent forceful termination.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def heal(self):
    &#34;&#34;&#34;Inspect and repair the state of the job.

    This method is normally invoked from a management service when
    a long running job doesn&#39;t seem healthy.
    Most likely because healthstate() returns bad reports:
    such as outdated heartbeat timestamp or a bad status code.
    The method should try to bring the job back to a healthy state
    as soon as possible to prevent forceful termination.
    &#34;&#34;&#34;</code></pre>
</details>
</dd>
<dt id="ambianic.util.ManagedService.healthcheck"><code class="name flex">
<span>def <span class="ident">healthcheck</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Report vital health information.</p>
<h2 id="returns">:Returns:</h2>
<p>touple (time, string)
(latest_heartbeat_timestamp, status_code)
latest_heartbeat_timestamp is in the format of time.monotonic().
status_code should have a semantic mapping to the service health.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@abstractmethod
def healthcheck(self):
    &#34;&#34;&#34;Report vital health information.

    :Returns:
    -------
    touple (time, string)
        (latest_heartbeat_timestamp, status_code)
        latest_heartbeat_timestamp is in the format of time.monotonic().
        status_code should have a semantic mapping to the service health.

    &#34;&#34;&#34;
    return time.monotonic(), &#34;OK&#34;</code></pre>
</details>
</dd>
<dt id="ambianic.util.ManagedService.start"><code class="name flex">
<span>def <span class="ident">start</span></span>(<span>self, **kwargs)</span>
</code></dt>
<dd>
<div class="desc"><p>Start and run until finished or asked to stop().</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@abstractmethod
def start(self, **kwargs):
    &#34;&#34;&#34;Start and run until finished or asked to stop().&#34;&#34;&#34;</code></pre>
</details>
</dd>
<dt id="ambianic.util.ManagedService.stop"><code class="name flex">
<span>def <span class="ident">stop</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Exit start() method as soon as possible.</p>
<p>Delay to exit may result in forceful process termination.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@abstractmethod
def stop(self):
    &#34;&#34;&#34;Exit start() method as soon as possible.

    Delay to exit may result in forceful process termination.
    &#34;&#34;&#34;</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="ambianic.util.ServiceExit"><code class="flex name class">
<span>class <span class="ident">ServiceExit</span></span>
<span>(</span><span>*args, **kwargs)</span>
</code></dt>
<dd>
<div class="desc"><p>Main program exit signal.</p>
<p>Custom exception which is used to trigger clean exit
of all running threads and the main program.</p>
<p>Method for controlled multi-threaded Python app exit
suggested by George Notaras:
<a href="https://www.g-loaded.eu/2016/11/24/how-to-terminate-running-python-threads-using-signals/">https://www.g-loaded.eu/2016/11/24/how-to-terminate-running-python-threads-using-signals/</a></p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class ServiceExit(Exception):
    &#34;&#34;&#34;Main program exit signal.

    Custom exception which is used to trigger clean exit
    of all running threads and the main program.

    Method for controlled multi-threaded Python app exit
    suggested by George Notaras:
    https://www.g-loaded.eu/2016/11/24/how-to-terminate-running-python-threads-using-signals/
    &#34;&#34;&#34;</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li>builtins.Exception</li>
<li>builtins.BaseException</li>
</ul>
</dd>
<dt id="ambianic.util.ThreadedJob"><code class="flex name class">
<span>class <span class="ident">ThreadedJob</span></span>
<span>(</span><span>job=None, **kwargs)</span>
</code></dt>
<dd>
<div class="desc"><p>A job that runs in its own python thread.</p>
<p>Jobs managed by Threaded Job must implement all ManagedService methods.</p>
<p>Inititalize with a ManagedService.</p>
<h2 id="parameters">:Parameters:</h2>
<p>job : ManagedService
The underlying service wrapped in this thread.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class ThreadedJob(Thread, ManagedService):
    &#34;&#34;&#34;A job that runs in its own python thread.

    Jobs managed by Threaded Job must implement all ManagedService methods.
    &#34;&#34;&#34;

    # Reminder: even though multiple processes can work well for pipelines,
    # since they are mostly independent,
    # Google Coral does not allow access to it from different processes yet.
    # Consider moving access to coral in a separate process that can serve
    # an inference task queue from multiple pipelines.

    def __init__(self, job=None, **kwargs):
        &#34;&#34;&#34;Inititalize with a ManagedService.

        :Parameters:
        ----------
        job : ManagedService
            The underlying service wrapped in this thread.
        &#34;&#34;&#34;
        Thread.__init__(self, daemon=True)
        assert isinstance(job, ManagedService)
        self.job = job
        # The shutdown_flag is a threading.Event object that
        # indicates whether the thread should be terminated.
        # self.shutdown_flag = threading.Event()
        # ... Other thread setup code here ...
        self._stop_requested = Event()

    def run(self):
        log.info(
            &#34;Thread #%s started with job: %s&#34;, self.ident, self.job.__class__.__name__
        )
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        self.job.start()
        log.info(
            &#34;Thread #%s for job %s stopped&#34;, self.ident, self.job.__class__.__name__
        )

    def stop(self):
        log.debug(
            &#34;Thread #%s for job %s is signalled to stop&#34; &#34;Passing request to job.&#34;,
            self.ident,
            self.job.__class__.__name__,
        )
        self._stop_requested.set()
        self.job.stop()

    def heal(self):
        log.debug(
            &#34;Thread #%s for job %s is signalled to heal.&#34; &#34;Passing request to job.&#34;,
            self.ident,
            self.job.__class__.__name__,
        )
        self.job.heal()
        log.debug(
            &#34;Thread #%s for job %s completed heal request.&#34;,
            self.ident,
            self.job.__class__.__name__,
        )

    def healthcheck(self):
        log.debug(
            &#34;Thread #%s for job %s healthcheck requested.&#34; &#34;Passing request to job.&#34;,
            self.ident,
            self.job.__class__.__name__,
        )
        health_status = self.job.healthcheck()
        return health_status</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li>threading.Thread</li>
<li><a title="ambianic.util.ManagedService" href="#ambianic.util.ManagedService">ManagedService</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="ambianic.util.ThreadedJob.run"><code class="name flex">
<span>def <span class="ident">run</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Method representing the thread's activity.</p>
<p>You may override this method in a subclass. The standard run() method
invokes the callable object passed to the object's constructor as the
target argument, if any, with sequential and keyword arguments taken
from the args and kwargs arguments, respectively.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def run(self):
    log.info(
        &#34;Thread #%s started with job: %s&#34;, self.ident, self.job.__class__.__name__
    )
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    self.job.start()
    log.info(
        &#34;Thread #%s for job %s stopped&#34;, self.ident, self.job.__class__.__name__
    )</code></pre>
</details>
</dd>
</dl>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="ambianic.util.ManagedService" href="#ambianic.util.ManagedService">ManagedService</a></b></code>:
<ul class="hlist">
<li><code><a title="ambianic.util.ManagedService.heal" href="#ambianic.util.ManagedService.heal">heal</a></code></li>
<li><code><a title="ambianic.util.ManagedService.healthcheck" href="#ambianic.util.ManagedService.healthcheck">healthcheck</a></code></li>
<li><code><a title="ambianic.util.ManagedService.start" href="#ambianic.util.ManagedService.start">start</a></code></li>
<li><code><a title="ambianic.util.ManagedService.stop" href="#ambianic.util.ManagedService.stop">stop</a></code></li>
</ul>
</li>
</ul>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="ambianic" href="index.html">ambianic</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="ambianic.util.jsonify" href="#ambianic.util.jsonify">jsonify</a></code></li>
<li><code><a title="ambianic.util.stacktrace" href="#ambianic.util.stacktrace">stacktrace</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="ambianic.util.JsonEncoder" href="#ambianic.util.JsonEncoder">JsonEncoder</a></code></h4>
<ul class="">
<li><code><a title="ambianic.util.JsonEncoder.default" href="#ambianic.util.JsonEncoder.default">default</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="ambianic.util.ManagedService" href="#ambianic.util.ManagedService">ManagedService</a></code></h4>
<ul class="">
<li><code><a title="ambianic.util.ManagedService.heal" href="#ambianic.util.ManagedService.heal">heal</a></code></li>
<li><code><a title="ambianic.util.ManagedService.healthcheck" href="#ambianic.util.ManagedService.healthcheck">healthcheck</a></code></li>
<li><code><a title="ambianic.util.ManagedService.start" href="#ambianic.util.ManagedService.start">start</a></code></li>
<li><code><a title="ambianic.util.ManagedService.stop" href="#ambianic.util.ManagedService.stop">stop</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="ambianic.util.ServiceExit" href="#ambianic.util.ServiceExit">ServiceExit</a></code></h4>
</li>
<li>
<h4><code><a title="ambianic.util.ThreadedJob" href="#ambianic.util.ThreadedJob">ThreadedJob</a></code></h4>
<ul class="">
<li><code><a title="ambianic.util.ThreadedJob.run" href="#ambianic.util.ThreadedJob.run">run</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>